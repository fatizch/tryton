# vim: set ft=sh:
# test management

_coog_test_enter() { # set test context
        # very specific vars for test (overriding TRYTOND_CONFIG)
        export TRYTOND_CONFIG=$COOG_CONF_TEST
        # TODO: review - already in config
        export TRYTOND_DATABASE_URI=`python2 .py/parse-config.py $COOG_CONF_TEST database uri`
        export DB_NAME="test_"`date +%s%N`
        export DO_NOT_TEST_CASES=1
}

_coog_test_leave() { # clean test config
        coog_test_dropdb $DB_NAME
}

coog_test_dropdb() { # drop db from test database - <db> - default: test_*
        local vars
        vars=`python2 .py/parse-config.py $COOG_CONF_TEST database uri | python2 .py/parse-url.py`
        export PGHOST=`echo "$vars" | sed -n 1p`
        export PGPORT=`echo "$vars" | sed -n 2p`
        export PGUSER=`echo "$vars" | sed -n 3p`
        export PGPASSWORD=`echo "$vars" | sed -n 4p`
        [ $# -gt 0 ] && dropdb -e $* && return
        local db
        for db in `psql -lX | grep "test_" | cut -f1 -d "|"`
        do
                dropdb -e $db
        done

}

coog_test_py() { # launch py.test on a module - <module> - all (further args are fwded to py.test)
        [ $# -eq 0 ] && echo needs module name to test && return
        _coog_test_enter
        local old_wd
        old_wd=`pwd`
        cd ../../trytond/trytond/modules
        local module
        module=$1
        shift 1
        if [ ! -d $module ]
        then
                echo module not found && cd $old_wd && return
        fi
        py.test $module --ignore=$module/test_case.py --doctest-glob=scenario*.rst $*
        cd $old_wd
        _coog_test_leave
}

coog_test_main() { # launch unit tests on a module - <module> - default: all
        _coog_test_enter
        run-tests.py -c $TRYTOND_CONFIG -vv -m $*
        _coog_test_leave
}
