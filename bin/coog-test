# vim: set ft=sh:
# test management

_coog_test_modules() { # list all linked modules
        for f in $COOG_TRYTOND/trytond/modules/*
        do
                [ -d $f ] && basename $f
        done
}

_coog_test_env() { # set test env
        TRYTOND_CONFIG=$COOG_CONF_TEST
        [ -z $TRYTOND_CONFIG ] && echo "missing conf file" && return 1
        TRYTOND_DATABASE_URI=`python $COOG_BIN/parse-config.py database uri < $COOG_CONF_TEST 2> /dev/null`
        [ $? -ne 0 ] && unset TRYTOND_DATABASE_URI
        unset DB_NAME
        export DO_NOT_TEST_CASES=1
}

coog_test_generate() { # generate test jobs - [module*]
        _coog_test_env || return $!
        local modules
        if [ $# -eq 0 ]
        then
                modules=`_coog_test_modules`
        else
                modules=$*
        fi
        python $COOG_BIN/test-generate.py $modules
}

coog_test_start() { # start test workers - <concurrency>
        [ -z $1 ] && echo missing workers number && return 1
        _coog_test_env || return $!
        coog_rq_qstart test $COOG_TMP/$COOG_FILE_TEST $1
}

coog_test_exec() { # exec tests - <concurrency> [module*]
        local nb; nb=$1; shift
        coog_test_generate $*
        coog_test_start $nb
}

coog_test_stop() { # stop test workers
        coog_rq_qstop $COOG_TMP/$COOG_FILE_TEST
}

coog_test_status() { # status of current run
        coog_rq_cli info
        echo ""
        echo ""
        echo "Currently running :"
        echo ""
        coog_test_query list wait | grep `date -Idate`
        echo ""
        echo "Failures :"
        echo ""
        coog_test_query list fail | more
}


coog_test_check() { # watch current status live
        watch -n 1 "coog test status"
}

coog_test_query() { # query test redis - [arg*]
        if [ list = "$1" ]
        then
                coog_redis_eval rq redis/test.lua $* | column -t | less
        else
                coog_redis_eval rq redis/test.lua $*
        fi
}

coog_test_log() { # print batch logs
        local args
        local fs
        fs=`ls $COOG_TMP/$COOG_FILE_TEST*.out 2> /dev/null`
        [ $? -ne 0 ] && echo no logs && return
        local f
        for f in "$fs"
        do
                args="$args $f"
        done
        cat $* $args
}

coog_test_logclear() {
        rm -vf $COOG_TMP/$COOG_FILE_TEST*.out
}

coog_test_py() { # launch py.test on a module - <module> - all (further args are fwded to py.test)
        [ $# -eq 0 ] && echo needs module name to test && return
        _coog_test_enter
        local old_wd
        old_wd=`pwd`
        cd $COOG_TRYTOND/trytond/modules
        local module
        module=$1
        shift 1
        if [ ! -d $module ]
        then
                echo module not found && cd $old_wd && return
        fi
        py.test $module --ignore=$module/test_case.py --doctest-glob=scenario*.rst $*
        cd $old_wd
}

coog_test_manual() { # interactively launch tests - <module> - default: all
        TRYTOND_CONFIG=$COOG_CONF_TEST
        [ -z $TRYTOND_CONFIG ] && echo "missing conf file" && return 1
        export TRYTOND_CONFIG
        TRYTOND_DATABASE_URI=`python $COOG_BIN/parse-config.py database uri < $COOG_CONF_TEST 2> /dev/null`
        [ $? -eq 0 ] && [ ! -z "$TRYTOND_DATABASE_URI" ] && export TRYTOND_DATABASE_URI
        export DB_NAME="test_"`date +%s%N`
        export DO_NOT_TEST_CASES=1
        run-tests.py -c $TRYTOND_CONFIG -vv -m $*
}
