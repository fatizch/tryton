#!/bin/bash
# This script checks if today is a weekday or a month first day eve.
# If yes, it executes the different chain.
# There is another test executing the monthly chain.
# You can add chain regarding the executing frequencies.
# This script is executed every day, thanks to a crontab.

_coog_daily_is_weekday() {  # return 0 if date is a work day
    [ "$TODAY_WEEK_DAY" -lt "6" ] && [ "$TODAY_WEEK_DAY" -gt "0" ]
}


_coog_daily_check_modules() {
    coog_module_status "$1" | grep -q '> activated'
    if [ "$?" -eq 0 ]; then
        return 0
    fi
    echo "Missing module $1 Skipping chain..."
    return 1
}

coog_daily_report() { # batches execution report generation
    local template=$(python "$COOG_BIN/parse-config.py" batch_report template < "$COOG_CONF_SRV" | sed -e "s/.*://" 2> /dev/null)
    [[ -z "$template" ]] && template="$COOG_BIN/template/default_batch_template.html"
    coog_celery_report "$@" | python "$COOG_BIN/batch_report_generate.py" "$template"
}

coog_daily_mail() { # batches execution mail report - [from_date~to_date] where dates are formated YYYY-MM-DDTHH:mm:SS
    local dates
    if [ -z "$1" ]; then
        dates="$(date -d "$(date --iso) -1 day" +%Y-%m-%d)T12:00:00~$(date +%Y-%m-%d)T23:59:59"
    else
        dates="$1"
    fi
    [ $# -ne 0 ] && dates=$1 && shift 1
    local fromemail=$(python "$COOG_BIN/parse-config.py" batch_report fromemail < "$COOG_CONF_SRV" | sed -e "s/.*://" 2> /dev/null)
    local toemail=$(python "$COOG_BIN/parse-config.py" batch_report toemail < "$COOG_CONF_SRV" | sed -e "s/.*://" 2> /dev/null)
    local body=$(coog_daily_report "$dates" "$@")
    local subject=$(sed -n -e 's/.*<title>\(.*\)<\/title>.*/\1/p' <<< $body)
    echo "$body" | python "$COOG_BIN/mail.py" --fromemail "$fromemail" --toemail "$toemail" --subject "$subject" 
}

coog_daily_main() { # launches daily chain 
    daily_module=$(python "$COOG_BIN/parse-config.py" batch daily 2>/dev/null < "$COOG_CONF_SRV")
    if [ "$daily_module" = "" ]; then
        daily_module=coog_core
    fi
    source "$COOG_TRYTOND/trytond/modules/$daily_module/bin/daily"

    coog_daily_run $*

    exit $?
}
