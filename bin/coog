#!/bin/bash

# This is the only reason why we use bash (not simply sh)
set -o pipefail


_enter() { # move to bin directory
        local script_path
        local script_dir
        script_path=`readlink -f $0`
        script_dir=`dirname $script_path`
        _wd=`pwd`
        cd $script_dir
}

_leave() { # move back to initial wd
        cd $_wd
}

_usage() { # print usage message
        echo
        echo Usage: coog \<command\> \[\<sub-command\> \[\<args\>\]\]
        echo
        echo "  "For help: coog help [\<command\>]
        echo "  "For support: support@coopengo.com
        echo
}

_source() { # source libs
        local fn
        for fn in ./coog-*
        do
                . $fn
        done
}

_main() { # parse params and call fn
        [ $# -eq 0 ] && _usage && return
        local com=$1
        local sub
        local fn
        if [ $# -eq 1 ] || [ "$com" = help ]
        then
                # implicit sub-command (no args possible)
                sub=main
                shift 1
        else
                # explicit sub-command
                sub=$2
                shift 2
                if [ "$sub" = -- ] # a way to pass args to main
                then
                        sub=main
                fi
        fi
        fn="coog_"$com"_"$sub
        if [ $com = init ] || [ $com = help ]
        then
                _source && coog_env_bootstrap && $fn "$@"
        else
                _source && coog_env_init && $fn "$@"
        fi
}

_enter
_main "$@"
_r=$?
_leave
exit $_r
