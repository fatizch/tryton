#!/bin/sh

# This command starts a Coog container
#
# Options explanations:
#     -d: as daemon
#     --name: name of the container. in case of multi-containers => coog-n
#     --link: to link to database (container-name:internal-reference)
#     -v: we map a fs volume to hold data (i.e. attachments)
#     -e: to set variables inside the container
#
# Coog image variables:
#     database:
#         COOG_DB_SYS: defaults to postgresql
#         COOG_DB_HOST: if not defined, POSTGRES_PORT_5432_TCP_ADDR is used
#         COOG_DB_PORT: if not defined, POSTGRES_PORT_5432_TCP_PORT is used
#         COOG_DB_USER: mandatory
#         COOG_DB_PASSWORD: mandatory
#     cache:
#         COOG_CACHE_HOST: if not defined, REDIS_PORT_6379_TCP_ADDR is used
#                          if REDIS_PORT_6379_TCP_ADDR not defined, Redis is not used
#         COOG_CACHE_PORT: if not defined, REDIS_PORT_6379_TCP_PORT is used
#         COOG_CACHE_DB: mandatory when a Redis host is defined
#     sentry:
#         COOG_SENTRY_PROTOCOL: defaults to http
#         COOG_SENTRY_HOST: if not defined, Sentry is not used
#         COOG_SENTRY_PORT: defaults to 9000
#         COOG_SENTRY_PUB: mandatory when Sentry host is defined
#         COOG_SENTRY_SEC: mandatory when Sentry host is defined
#         COOG_SENTRY_PROJECT: mandatory when Sentry host is defined
#
# More informations: https://docs.docker.com/engine/reference/run/

image=`head -1 ./tags`

data=`pwd`/data/coog

coog_db_user=postgres
coog_db_password=postgres
coog_cache_db=0
coog_sentry_host=`./ip sentry`
coog_sentry_pub=pub            # part of the dsn (open sentry admin to get one)
coog_sentry_sec=sec            # part of the dsn (open sentry admin to get one)
coog_sentry_project=project    # part of the dsn (open sentry admin to get one)

sudo docker run \
        -d \
        --name coog \
        --link postgres:postgres \
        -e "COOG_DB_USER=$coog_db_user" \
        -e "COOG_DB_PASSWORD=$coog_db_password" \
        --link redis:redis \
        -e "COOG_CACHE_DB=$coog_cache_db" \
        --link sentry:sentry \
        -e "COOG_SENTRY_HOST=$coog_sentry_host" \
        -e "COOG_SENTRY_PUB=$coog_sentry_pub" \
        -e "COOG_SENTRY_SEC=$coog_sentry_sec" \
        -e "COOG_SENTRY_PROJECT=$coog_sentry_project" \
        -v $data:/opt/coog/data \
        coog/$image \
        app $*
