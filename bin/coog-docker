# vim: set ft=sh:
# docker utils for coog server

coog_docker_env() { # build docker env image - [docker-build-arg*]
        [ -d .cache ] && rm -rf .cache
        docker build -t coog/env -f conf/env.df $* .
}

coog_docker_hashpwd() { # hash trytond super pwd - <pwd>
        python2 -c "import crypt,random,string; print crypt.crypt('$1', ''.join(random.sample(string.ascii_letters + string.digits, 8)))"
}

coog_docker_build() { # build docker image - <pwd> [image*] -- [docker-build-arg*]
        [ $# -lt 4 ] && \
                echo needs at least trytond, trytond-modules and coog to build && \
                return 1
        [ -d .cache ] && rm -rf .cache
        mkdir .cache
        local pass; pass=$1; shift
        coog_docker_hashpwd $pass > .cache/.password
        local image; image=$1
        while [ ! -z $1 ]
        do
                [ $1 = "--" ] && shift && break
                local component; component=$1; shift
                local repo
                local tree
                repo=`echo $component | cut -d ":" -f 1`
                tree=`echo $component | cut -d ":" -f 2`
                [ ! -d ../../$repo ] && echo repo $repo does not exist && return
                local wd
                wd=`pwd`
                cd ../../$repo
                echo $repo:$tree:`git rev-parse $tree` >> $wd/.cache/.version || \
                        (echo bad revision $tree from $repo && return)
                git archive --format tar $tree | \
                        (mkdir $wd/.cache/$repo && cd $wd/.cache/$repo && tar xf -)
                cd $wd
        done
        cp conf/coog.df .cache
        docker build -t coog/$image -f .cache/coog.df $* .cache
}

coog_docker_clean() { # clean images and volumes
        docker rmi `docker images -q -f dangling=true`
        docker run -v /var/run/docker.sock:/var/run/docker.sock \
                -v /var/lib/docker:/var/lib/docker \
                --rm \
                martin/docker-cleanup-volumes
}
