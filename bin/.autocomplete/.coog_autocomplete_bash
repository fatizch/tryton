#!/usr/bin/env bash
coog_autocomplete_update_bash() { # Set up tab completion for bash
    _completion_list() { # Bash Completion List
        local cur=${COMP_WORDS[COMP_CWORD]}
        local completion=()
        local command_path
        local script_path
        local script_dir
        command_path=$(which coog)
        script_path=$(readlink -f "$command_path")
        script_dir=$(dirname "$script_path")
        _wd=$(pwd)
        cd "$script_dir" || return
        case "$COMP_CWORD" in
            1)
                # managing 'coog' commands
                for fn in ./coog-*; do
                    completion+=("$(echo "$fn" | cut -d'-' -f 2)")
                done
                ;;
            2)
                # managing 'coog' sub-commands
                local com=${COMP_WORDS[COMP_CWORD-1]}
                case "$com" in
                    'help') # coog help: return all commands
                        for fn in ./coog-*; do
                            completion+=("$(echo "$fn" | cut -d'-' -f 2)")
                        done
                        ;;
                    *) # other coog commands: return related subcommands
                        while read -r line ; do
                            local subcom
                            subcom="$(echo "$line" | cut -d '_' -f 3 | sed 's/() *{ *# */ ---> /')"
                            if [ "$subcom" = main ]
                            then
                                continue
                            fi
                            completion+=("$subcom")
                        done < <(grep "^coog_" "coog-$com")
                        ;;
                esac
                ;;
        esac
        local IFS=$'\n'
        suggestions=($(compgen -W "$(printf "%s\n" "${completion[@]}")" -- "$cur"))
        if [ "${#suggestions[@]}" == "1" ]; then
            local value="${suggestions[0]/%\ */}"
            COMPREPLY=("$value")
        else
            COMPREPLY=("${suggestions[@]}")
        fi
        cd "$_wd" || exit 1
    }
complete -F _completion_list coog
}

if [ -n "$BASH" ] ; then
    coog_autocomplete_update_bash
fi
